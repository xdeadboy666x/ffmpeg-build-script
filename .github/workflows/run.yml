name: Build FFmpeg for Windows

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-ffmpeg:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository (necessary for GitHub Actions to run)
      - name: Checkout Repository
        uses: actions/checkout@v3

     # Cache system dependencies
      - name: Cache System Dependencies
        uses: actions/cache@v4.2.0
        with:
          path: /tmp/mingw-w64
          key: ${{ runner.os }}-mingw-w64-${{ hashFiles('**/build-ffmpeg.sh') }}
          restore-keys: |
            ${{ runner.os }}-mingw-w64-

      # Install dependencies for cross-compilation (only if not cached)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm pkg-config git \
            mingw-w64 cmake nasm

      # Clone FFmpeg build script
      - name: Clone FFmpeg Build Script
        run: git clone https://github.com/slyfox1186/ffmpeg-build-script.git

      # Set up MinGW environment
      - name: Set up MinGW for Windows Cross-Compilation
        run: |
          export PATH=/usr/x86_64-w64-mingw32/bin:$PATH
          export CROSS_PREFIX=x86_64-w64-mingw32-
          echo "MinGW cross-compiler setup completed"

      # Change to the FFmpeg build script directory
      - name: Change Directory
        working-directory: ffmpeg-build-script
        run: echo "Changed to $(pwd)"

      # Run the build script with cross-compilation flags
      - name: Run FFmpeg Build Script for Windows
        working-directory: ffmpeg-build-script
        run: |
          export TERM=xterm
          bash ./build-ffmpeg.sh --build --enable-gpl-and-non-free --latest

      # Store the build artifacts (Windows executables)
      - name: Upload Windows Executables
        uses: actions/upload-artifact@v3
        with:
          name: ffmpeg-windows-executables
          path: ffmpeg-build-script/ffmpeg*/ffmpeg.exe
